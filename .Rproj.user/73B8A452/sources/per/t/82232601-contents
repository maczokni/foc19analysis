---
title: "Changes in FoC"
author: "Reka Solymosi"
date: "10/06/2020"
output: word_document
always_allow_html: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(haven)
library(ggplot2)
library(tidyr)
library(stringr)
library(forcats)
library(nnet)
library(stargazer)
library(broom)
library(MASS)
library(dplyr)
library(networkD3)
library(moments)

# read in data
data <- read_dta("https://www.dropbox.com/s/l0k2if9axtpu8mu/Covid-19_Police_Study_Longitudinal_W1-W3.dta?dl=1")
#filter out people who didn't answer foc-19 Q and choose weight to use throughout
data <- data %>% filter(!is.na(b_foc)) %>% mutate(weight = ifelse(is.na(w1w2weight), 1, w1w2weight))

```

# Prevalence of worry

```{r focfreqtb}

foc_tab_w2 <- data %>% filter(!is.na(b_foc)) %>% group_by(b_foc) %>% count() %>% mutate(perc = round(n / sum(.$n)*100,0))
foc_tab_w3 <- data %>% filter(!is.na(c_foc)) %>% group_by(c_foc) %>% count() %>% mutate(perc = round(n / sum(.$n)*100,0))
data <- data %>% mutate(whochanged = case_when(b_foc == 1 & c_foc == 1 ~ "Experienced worry in both waves",
                                                      b_foc == 1 & c_foc == 2 ~ "Experienced worry in W2 but not W3", 
                                                      b_foc == 2 & c_foc == 1 ~ "Didn't worry in W2 but did in W3", 
                                                      b_foc == 2 & c_foc == 2 ~ "Didn't worry in either wave"))

```

When asked the question in wave 2 “In the past 3 weeks, have you ever felt worried about getting COVID-19?”, `r foc_tab_w2 %>% filter(b_foc == 2) %>% pull(perc)`% of people said that “No”, they had not felt worried about getting COVID-19 in the past 3 weeks. However, in wave three, `r foc_tab_w3 %>% filter(c_foc == 2) %>% pull(perc)`% of people said that “No”, they had not felt worried about getting COVID-19 in the past 3 weeks. Appears worry is on the decrease... `r nrow(data %>% filter(whochanged == "Experienced worry in W2 but not W3"))` people experienced worry in Wave 2, but not in Wave 3, while `r nrow(data %>% filter(whochanged == "Didn't worry in W2 but did in W3"))` people didn't report experiencing any worry in W2 but did in W3. `r nrow(data %>% filter(whochanged == "Experienced worry in both waves"))` reported that they experienced worry in both waves, while `r nrow(data %>% filter(whochanged == "Didn't worry in either wave"))` worried in neither.


Based on their worries about catching the virus, as well as the self-reported effect of their worries, we can divide research participants into one of three groups:

# Functional Fear

```{r newfoc19}
data <- data %>% 
  mutate(foc19_w2 = case_when(
          # Unworried
          b_foc==2 ~ "Unworried", # not worried
          # Functional
          b_foc==1 & # worried about catching covid in past 3 weeks
          b_focqol < 7   ~ "Coping",  #  quality of life is not reduced by worry
         #Dysfunctional
          b_foc== 1 & # worried about covid
            b_focqol > 6  ~ "Struggling", #quality of life affected by worry
          TRUE ~ NA_character_),    #everyone else 
         #wave3
         foc19_w3 = case_when(
          # Unworried
          c_foc==2 ~ "Unworried", # not worried
          # Functional
          c_foc==1 & # worried about catching covid in past 3 weeks
          c_focqol < 7   ~ "Coping",  #  quality of life is not reduced by worry
         #Dysfunctional
          c_foc== 1 & # worried about covid
            c_focqol > 6  ~ "Struggling", #quality of life affected by worry
          TRUE ~ NA_character_),    #everyone else 
    ) 

data$foc19_w2 <- factor(data$foc19_w2, levels = c("Unworried", "Coping","Struggling" ))
data$foc19_w3 <- factor(data$foc19_w3, levels = c("Unworried", "Coping","Struggling" ))


```


```{r funcworrychanges}

data <- data %>% mutate(
  whochangedff = case_when(foc19_w2 == "Unworried" & foc19_w3 == "Unworried" ~ "Stayed Unworried",
                           foc19_w2 == "Coping" & foc19_w3 == "Coping" ~ "Stayed Coping",
                           foc19_w2 == "Struggling" & foc19_w3 == "Struggling" ~ "Stayed Struggling",
                           foc19_w2 == "Unworried" & foc19_w3 == "Coping" ~ "Unworried to Coping",
                           foc19_w2 == "Unworried" & foc19_w3 == "Struggling" ~ "Unworried to Struggling", 
                           foc19_w2 == "Coping" & foc19_w3 == "Unworried" ~ "Coping to Unworried",
                           foc19_w2 == "Coping" & foc19_w3 == "Struggling" ~ "Coping to Struggling",
                           foc19_w2 == "Struggling" & foc19_w3 == "Unworried" ~ "Struggling to Unworried",
                           foc19_w2 == "Struggling" & foc19_w3 == "Coping" ~ "Struggling to Coping"))


```


```{r whochangedff}

data %>%  group_by(whochangedff) %>%  summarise(round(sum(weight), 0))

```
```{r sankey}

sankey_df <- as.data.frame(data %>% filter(!is.na(foc19_w3))%>% group_by(foc19_w2, foc19_w3) %>% count())
# "source" = foc19_w2, "target" = foc19_w3, "value" = n

sankey_df$foc19_w3 <- paste(sankey_df$foc19_w3, " ", sep="")

# Create nodes df
nodes <- data.frame(name=c(as.character(sankey_df$foc19_w2), as.character(sankey_df$foc19_w3)) %>% unique())

# With networkD3, connection must be provided using id, not using real name like in the links dataframe.. So we need to reformat it.
sankey_df$IDsource=match(sankey_df$foc19_w2, nodes$name)-1 
sankey_df$IDtarget=match(sankey_df$foc19_w3, nodes$name)-1


# Make the Network
sankeyNetwork(Links = sankey_df, Nodes = nodes,
              Source = "IDsource", Target = "IDtarget",
              Value = "n", NodeID = "name")


```



# Is there association between change in circumstance and change in foc19 group?

## How covid19 has affected their lives


I created a score from summing up all the effects of covid (covidaffet_1 through 8) for wave 2 and for wave 3, then I subtracted the wave 3 score from the wave 2 score. So a higher score means that things have improved, while a lower score means that things have gotten worse between the two waves. This score seems to have no effect on the type of move between categories (ie I expected those who moved from unworried to struggling to have low score (things changed for the worse for them), and those who moved from struggling to unworried to have high score (things changed for the better for them), but did not see this at all):


```{r circchangevworrychange}

data <- data %>% 
  rowwise() %>% 
  mutate(covaff_w2 = sum(b_covidaffect_1, b_covidaffect_2 , b_covidaffect_3,
                         b_covidaffect_4, b_covidaffect_5 , b_covidaffect_6,
                         b_covidaffect_7, b_covidaffect_8 , na.rm = T), 
         covaff_w3 = sum(c_covidaffect_1, c_covidaffect_2 , c_covidaffect_3,
                         c_covidaffect_4, c_covidaffect_5 , c_covidaffect_6,
                         c_covidaffect_7, c_covidaffect_8 , na.rm = T), 
         covaff_diff = covaff_w2 - covaff_w3, 
         fromwhere = case_when(
           whochangedff %in% c("Unworried to Coping", "Unworried to Struggling", "Stayed Unworried") ~"From Unworried",
           whochangedff %in% c("Coping to Unworried", "Coping to Struggling", "Stayed Coping") ~"From Coping",
           whochangedff %in% c("Struggling to Coping", "Struggling to Unworried", "Stayed Struggling") ~"From Struggling"
                               ))



# 
# ggplot(data %>% filter(!is.na(whochangedff)), aes(x = whochangedff, y = covaff_diff, group = whochangedff)) + 
#   geom_violin() + 
#   facet_wrap(~fromwhere, scales = "free") 
#   


raincloud_theme = theme(
text = element_text(size = 10),
axis.title.x = element_text(size = 16),
axis.title.y = element_text(size = 16),
axis.text = element_text(size = 14),
# axis.text.x = element_text(angle = 45, vjust = 0.5),
legend.title=element_text(size=16),
legend.text=element_text(size=16),
legend.position = "right",
plot.title = element_text(lineheight=.8, face="bold", size = 16),
panel.border = element_blank(),
panel.grid.minor = element_blank(),
panel.grid.major = element_blank(),
axis.line.x = element_line(colour = 'black', size=0.5, linetype='solid'),
axis.line.y = element_line(colour = 'black', size=0.5, linetype='solid'))
source("https://gist.githubusercontent.com/benmarwick/2a1bb0133ff568cbe28d/raw/fb53bd97121f7f9ce947837ef1a4c65a73bffb3f/geom_flat_violin.R")

ggplot(data = data %>% filter(!is.na(whochangedff)), aes(x = whochangedff, y = covaff_diff, fill = whochangedff)) +
geom_flat_violin(position = position_nudge(x = .2, y = 0), alpha = .8) +
geom_point(aes(y = covaff_diff, color = whochangedff), position = position_jitter(width = .15), size = .5, alpha = 0.8) +
geom_boxplot(width = .1, guides = FALSE, outlier.shape = NA, alpha = 0.5) +
expand_limits(x = 5.25) +
guides(fill = FALSE) +
guides(color = FALSE) +
scale_color_brewer(palette = "Spectral") +
scale_fill_brewer(palette = "Spectral") +
coord_flip() +
theme_bw() +
raincloud_theme + 
  ylab("Covid Affected Score") + 
  xlab("")
  


```


## Change in keyworker status 

I could not find b_covidjob and c_covidjob in this dataset, only a_covidjob...!

```{r keyworkerchange}

# data <- data %>% mutate(keywrkrdiff = case_when( ))

```


## What about getting covid19 themselves? 

I also looked at change in having Covid19 between the waves. 


```{r covid19status}

data <- data %>% 
  mutate(covdiff = case_when(
    b_cov %in% c(1, 2, 3) &
      c_cov %in% c(1,2,3) ~ "Had in both waves", 
    b_cov == 3 &
      c_cov == 4 ~ "Suspected in W2 but said didnt have in W3", 
    b_cov== 4 &
     c_cov %in% c(1,2,3) ~ "Had in W3 not W2", 
    b_cov == 4 & 
      c_cov ==4 ~ "Didnt have cov19 either wave", 
    b_cov %in% c(1, 2, 3) &
      is.na(c_cov) ~ "Had covid in W2, didn't answer W3 (possibly ded?)",
    TRUE ~ NA_character_
  ))

data %>% group_by(covdiff) %>% count()

```

The 26 people who got covid (or suspected) in the last 3 weeks have changed in their worry all over the place... Some got less worried (eg: 2 of them moved from struggling to unworried) while others got more worried (2 moved from coping to struggling, 1 from unworried to coping...)

```{r gotcovworry}

data %>% filter(covdiff == "Had in W3 not W2") %>% group_by(whochangedff) %>% count()

```
So not this either... 


## Concern and change in worry group?

I also looked at convid concern between the waves: 

```{r covconc}
data <- data %>%  
  mutate(covconcdiff = case_when(
    b_covconc < 4 & 
      c_covconc < 4 ~ "Not concerned in both waves", 
    b_covconc < 4 & 
      c_covconc > 3 ~ "Not concerned in W2 concerned in W3", 
        c_covconc < 4 & 
      b_covconc > 3 ~ "Concerned in W2 no longer concerned in W3", 
    b_covconc > 3 &
      c_covconc > 3 ~ "Concerned in both waves", 
    TRUE ~ NA_character_
    
  ))

data %>% group_by(covconcdiff) %>% count()

```


So this one makes more sense, in that those who were not concerned in both are also those who stayed unworried, most of those that were concerned in w2 but not in w3 are in the coping to unworried or struggling to unworried move... But this isn't really that exciting as these should really measure the same thing (ish), rather than one explaining the other... 


```{r covconcvff}

data %>% 
  filter(!is.na(whochangedff)) %>% 
  group_by(whochangedff, covconcdiff) %>% 
  count() %>% 
  ggplot(., aes(x = whochangedff, y = n, fill = covconcdiff)) + 
  geom_bar(stat = "identity", position = "stack") + 
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```


# Conclusions


Anyway, from this we can say nothing about why people move between categories, so I think at this point, the best thing to do is to just make a note at the end of the categories paper that people do move between the categories, we don't know why, this is something we can explore later... 



